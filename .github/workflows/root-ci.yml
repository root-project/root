name: 'ROOT CI'

on:
  # https://github.com/root-project/root/pull/12112#issuecomment-1411004278
  pull_request:
    branches:
      - '**'
    paths-ignore:
      - 'doc/**'
      - 'documentation/**'
      - 'README/ReleaseNotes/**'

  push:
    branches:
      - 'master'
      - 'v*-*-*-patches'
    paths-ignore:
      - 'doc/**'
      - 'documentation/**'
      - 'README/**'

  # Allows nightly builds to trigger one run for each branch easily, by
  # providing the relevant branch as "default" value here:
  workflow_call:
    inputs:
      head_ref:
        type: string
        default: master
      base_ref:
        type: string
        default: master
      ref_name:
        type: string
        default: master

  # Enables manual start of workflow
  workflow_dispatch:
    inputs:
      head_ref:
        description: rebase from ...
        type: string
        required: true
        default: master
      base_ref:
        description: ... to ... (can have same value)
        type: string
        required: true
        default: master
      incremental:
        description: 'Do incremental build'
        type: boolean
        required: true
        default: true
      binaries:
        description: Create binary packages and upload them as artifacts
        type: boolean
        required: true
        default: false
      buildtype:
        description: The CMAKE_BUILD_TYPE to use for non-Windows.
        type: choice
        options:
        - Debug
        - RelWithDebInfo
        - Release
        - MinSizeRel
        default: Debug
        required: true

env:
  PYTHONUNBUFFERED: true
  OS_APPLICATION_CREDENTIAL_ID: '7f5b64a265244623a3a933308569bdba'
  OS_APPLICATION_CREDENTIAL_SECRET: ${{ secrets.OS_APPLICATION_CREDENTIAL_SECRET }}
  OS_AUTH_TYPE: 'v3applicationcredential'
  OS_AUTH_URL: 'https://keystone.cern.ch/v3'
  OS_IDENTITY_API_VERSION: 3
  OS_INTERFACE: 'public'
  OS_REGION_NAME: 'cern'
  GLOBAL_OVERRIDES: 'asserts=ON LLVM_ENABLE_ASSERTIONS=ON'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  build-macos:
    # For any event that is not a PR, the CI will always run. In PRs, the CI
    # can be skipped if the tag [skip-ci] or [skip ci] is written in the title.
    if: |
        (github.repository_owner == 'root-project' && github.event_name != 'pull_request') ||
        (github.event_name == 'pull_request' && !(
          contains(github.event.pull_request.title, '[skip-ci]') ||
          contains(github.event.pull_request.title, '[skip ci]') ||
          contains(github.event.pull_request.labels.*.name, 'skip ci')
        ))

    permissions:
      contents: read

    defaults:
      run:
        shell: bash -leo pipefail {0} # Use login shell, so profile scripts get sourced

    env:
      VIRTUAL_ENV_DIR: ${{ github.workspace }}/ROOT_CI_VENV

    strategy:
      fail-fast: false
      matrix:
        # Specify platform + optional build option overrides
        # Build options: https://root.cern/install/build_from_source/#all-build-options
        include:
          - platform: mac14
            arch: X64
            overrides: ["CMAKE_CXX_STANDARD=20"]
          - platform: mac15
            arch: ARM64
            overrides: ["CMAKE_CXX_STANDARD=23"]
          - platform: mac26
            arch: ARM64
          - platform: mac-beta
            is_special: true
            arch: ARM64

    runs-on:
      - self-hosted
      - ${{ matrix.platform }}

    name: |
      ${{ matrix.platform }} ${{ matrix.arch }}
      ${{ (github.event_name != 'schedule' && github.event_name != 'workflow_dispatch' && join( matrix.overrides, ', ' )) || '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.ref_name }}
          path: "src/"

      - uses: root-project/gcc-problem-matcher-improved@main
        with:
          build-directory: /Users/sftnight/ROOT-CI/src/

      - name: Export SSL certificate files for Davix
        run: |
          for cert in /opt/homebrew/opt/ca-certificates/share/ca-certificates/cacert.pem /opt/local/share/curl/curl-ca-bundle.crt; do
            if [ -f ${cert} ]; then
              echo "SSL_CERT_FILE=${cert}" >> $GITHUB_ENV
            fi
          done

      - name: Pull Request Build
        if: github.event_name == 'pull_request'
        env:
          HOME: /Users/sftnight
          INCREMENTAL: ${{ !contains(github.event.pull_request.labels.*.name, 'clean build') && !matrix.platform == 'mac15' && !matrix.platform == 'mac26'}}
          GITHUB_PR_ORIGIN: ${{ github.event.pull_request.head.repo.clone_url }}
          OVERRIDES: ${{ join( matrix.overrides, ' ') }}
        run: |
          [ -d "${VIRTUAL_ENV_DIR}" ] && source ${VIRTUAL_ENV_DIR}/bin/activate
          echo "Python is now $(which python3) $(python3 --version)"
          src/.github/workflows/root-ci-config/build_root.py  \
                    --buildtype       RelWithDebInfo          \
                    --incremental     $INCREMENTAL            \
                    --base_ref        ${{ github.base_ref }}  \
                    --sha             ${{ github.sha }}       \
                    --pull_repository ${{ github.event.pull_request.head.repo.clone_url }}  \
                    --head_ref        refs/pull/${{ github.event.pull_request.number }}/head:${{ github.event.pull_request.head.ref }}  \
                    --head_sha        ${{ github.event.pull_request.head.sha }}             \
                    --repository      ${{ github.server_url }}/${{ github.repository }}     \
                    --platform        ${{ matrix.platform }}                                \
                    --overrides       ${GLOBAL_OVERRIDES} ${OVERRIDES}

      - name: Workflow dispatch
        if: ${{ github.event_name == 'workflow_dispatch' && !matrix.is_special }}
        run: |
          [ -d "${VIRTUAL_ENV_DIR}" ] && source ${VIRTUAL_ENV_DIR}/bin/activate
          echo "Python is now $(which python3) $(python3 --version)"
          src/.github/workflows/root-ci-config/build_root.py  \
                    --buildtype      ${{ inputs.buildtype }}  \
                    --platform       ${{ matrix.platform }}   \
                    --incremental    ${{ inputs.incremental }}\
                    --base_ref       ${{ inputs.base_ref }}   \
                    --head_ref       ${{ inputs.head_ref }}   \
                    --binaries       ${{ inputs.binaries }}   \
                    --repository     ${{ github.server_url }}/${{ github.repository }}

      - name: Nightly build
        if:   github.event_name == 'schedule'
        run: |
          [ -d "${VIRTUAL_ENV_DIR}" ] && source ${VIRTUAL_ENV_DIR}/bin/activate
          echo "Python is now $(which python3) $(python3 --version)"
          src/.github/workflows/root-ci-config/build_root.py  \
                    --buildtype      Release                  \
                    --platform       ${{ matrix.platform }}   \
                    --incremental    false                    \
                    --binaries       true                     \
                    --base_ref       ${{ inputs.ref_name }}   \
                    --repository     ${{ github.server_url }}/${{ github.repository }}

      - name: Update build cache after push to release branch
        if:   github.event_name == 'push'
        env:
          OVERRIDES: ${{ join( matrix.overrides, ' ') }}
        run: |
          [ -d "${VIRTUAL_ENV_DIR}" ] && source ${VIRTUAL_ENV_DIR}/bin/activate
          echo "Python is now $(which python3) $(python3 --version)"
          src/.github/workflows/root-ci-config/build_root.py  \
                    --buildtype      RelWithDebInfo           \
                    --platform       ${{ matrix.platform }}   \
                    --incremental    false                    \
                    --base_ref       ${{ github.ref_name }}   \
                    --binaries       ${{ startsWith(github.ref, 'refs/tags/') }}  \
                    --repository     ${{ github.server_url }}/${{ github.repository }}  \
                    --overrides       ${GLOBAL_OVERRIDES} ${OVERRIDES}

      - name: Upload test results
        if:   ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: Test Results ${{ matrix.platform }} ${{ matrix.arch }}
          path: /Users/sftnight/ROOT-CI/build/TestResults.xml

      - name: Upload binaries
        if:   ${{ !cancelled() && (inputs.binaries || github.event_name == 'schedule' || startsWith(github.ref, 'refs/tags/')) }}
        uses: actions/upload-artifact@v4
        with:
          name: Binaries ${{ matrix.platform }} ${{ matrix.arch }}
          path: /Users/sftnight/ROOT-CI/packages/root_v*
          if-no-files-found: error


  build-windows:
    # For any event that is not a PR, the CI will always run. In PRs, the CI
    # can be skipped if the tag [skip-ci] or [skip ci] is written in the title.
    if: |
        (github.repository_owner == 'root-project' && github.event_name != 'pull_request') ||
        (github.event_name == 'pull_request' && !(
          contains(github.event.pull_request.title, '[skip-ci]') ||
          contains(github.event.pull_request.title, '[skip ci]') ||
          contains(github.event.pull_request.labels.*.name, 'skip ci')
        ))

    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        # We have to get a bit creative here: GitHub actions only allows to
        # exclude partial matches, so we artificially add the event_name as
        # a "constant variable" that we can use to remove the Debug entries
        # for pull requests and on branch pushes. This is further complicated
        # by the fact that event_name is a string, but we need an array. So
        # we construct a JSON string that we can then convert into an array.
        event_name: ${{ fromJSON(format('["{0}"]', github.event_name)) }}
        config: ["RelWithDebInfo", "Release"]
        target_arch: [x64, x86]
        exclude:
          - event_name: pull_request
            config: RelWithDebInfo
          - event_name: push
            config: RelWithDebInfo
          # This is this platform is subject to timeouts when building from
          # scratch.
          #- target_arch: x86
          #  config: RelWithDebInfo

    name: Windows 10 ${{ matrix.target_arch }} ${{ matrix.config }}

    runs-on: # Using '[self-hosted, windows, ${{ matrix.arch }}]' does not work for some reason :)
      - self-hosted
      - windows
      - x64 # machine host, not build target
      - target${{ matrix.target_arch }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.ref_name }}

      - name: Pull Request Build
        if: github.event_name == 'pull_request'
        env:
          INCREMENTAL: ${{ !contains(github.event.pull_request.labels.*.name, 'clean build') }}
          GITHUB_PR_ORIGIN: ${{ github.event.pull_request.head.repo.clone_url }}
        shell: cmd
        run: "C:\\setenv.bat ${{ matrix.target_arch }} &&
              python .github/workflows/root-ci-config/build_root.py
                    --buildtype       ${{ matrix.config }}
                    --platform        windows10
                    --incremental     $INCREMENTAL
                    --base_ref        ${{ github.base_ref }}
                    --sha             ${{ github.sha }}
                    --pull_repository ${{ github.event.pull_request.head.repo.clone_url }}
                    --head_ref        refs/pull/${{ github.event.pull_request.number }}/head:${{ github.event.pull_request.head.ref }}
                    --head_sha        ${{ github.event.pull_request.head.sha }}
                    --repository      ${{ github.server_url }}/${{ github.repository }}
                    --architecture    ${{ matrix.target_arch }}"

      - name: Workflow dispatch/call
        if:   github.event_name == 'workflow_dispatch'
        shell: cmd
        run: "C:\\setenv.bat ${{ matrix.target_arch }} &&
              python .github/workflows/root-ci-config/build_root.py
                    --buildtype    ${{ matrix.config }}
                    --platform     windows10
                    --incremental  ${{ inputs.incremental }}
                    --base_ref     ${{ inputs.base_ref }}
                    --head_ref     ${{ inputs.head_ref }}
                    --binaries     ${{ inputs.binaries }}
                    --repository   ${{ github.server_url }}/${{ github.repository }}
                    --architecture ${{ matrix.target_arch }}"

      - name: Nightly build
        if:   github.event_name == 'schedule'
        shell: cmd
        run: "C:\\setenv.bat ${{ matrix.target_arch }} &&
              python .github/workflows/root-ci-config/build_root.py
                    --buildtype    ${{ matrix.config }}
                    --platform     windows10
                    --incremental  false
                    --binaries     true
                    --base_ref     ${{ inputs.ref_name }}
                    --repository   ${{ github.server_url }}/${{ github.repository }}
                    --architecture ${{ matrix.target_arch }}"

      - name: Update build cache after push to release branch
        if:   github.event_name == 'push'
        shell: cmd
        run: "C:\\setenv.bat ${{ matrix.target_arch }} &&
              python .github/workflows/root-ci-config/build_root.py
                    --buildtype    ${{ matrix.config }}
                    --platform     windows10
                    --incremental  false
                    --base_ref     ${{ github.ref_name }}
                    --binaries     ${{ startsWith(github.ref, 'refs/tags/') }}
                    --repository   ${{ github.server_url }}/${{ github.repository }}
                    --architecture ${{ matrix.target_arch }}"

      - name: Upload test results
        if:   ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: Test Results Windows ${{ matrix.target_arch }} ${{ matrix.config }}
          path: C:/ROOT-CI/build/TestResults.xml

      - name: Upload binaries
        if:   ${{ !cancelled() && (inputs.binaries || github.event_name == 'schedule' || startsWith(github.ref, 'refs/tags/')) }}
        uses: actions/upload-artifact@v4
        with:
          name: Binaries ${{ matrix.target_arch }} ${{ matrix.config }}
          path: C:/ROOT-CI/packages/root_v*
          if-no-files-found: error


  build-linux:
    # For any event that is not a PR, the CI will always run. In PRs, the CI
    # can be skipped if the tag [skip-ci] or [skip ci] is written in the title.
    if: |
        (github.repository_owner == 'root-project' && github.event_name != 'pull_request') ||
        (github.event_name == 'pull_request' && !(
          contains(github.event.pull_request.title, '[skip-ci]') ||
          contains(github.event.pull_request.title, '[skip ci]') ||
          contains(github.event.pull_request.labels.*.name, 'skip ci')
        ))

    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        # Specify image + (optional) build option overrides
        #
        # Available images: https://github.com/root-project/root-ci-images
        # Common configs: {Release,Debug,RelWithDebInfo)
        # Build options: https://root.cern/install/build_from_source/#all-build-options
        include:
          - image: fedora42
            overrides: ["CMAKE_CXX_STANDARD=23"]
          - image: fedora43
          - image: alma8
          - image: alma9
            overrides: ["CMAKE_BUILD_TYPE=Debug"]
          - image: alma10
          - image: ubuntu22
            overrides: ["imt=Off", "CMAKE_BUILD_TYPE=Debug"]
          - image: ubuntu2404
            overrides: ["CMAKE_BUILD_TYPE=Debug"]
          - image: ubuntu2510
          - image: debian125
            overrides: ["CMAKE_CXX_STANDARD=20", "dev=ON", "CMAKE_CXX_FLAGS=-Wsuggest-override"]
          - image: debian13
            overrides: ["dev=ON", "CMAKE_CXX_FLAGS=-Wsuggest-override"]
          # Special builds
          - image: alma9
            is_special: true
            property: modules_off
            overrides: ["runtime_cxxmodules=Off", "CMAKE_CXX_STANDARD=20"]
          - image: alma9
            is_special: true
            property: march_native
            overrides: ["CMAKE_BUILD_TYPE=RelWithDebInfo", "CMAKE_CXX_FLAGS=-march=native", "CMAKE_C_FLAGS=-march=native", "builtin_zlib=ON", "builtin_zstd=ON", "CMAKE_CXX_STANDARD=20", "builtin_vc=ON", "builtin_veccore=ON", "vc=ON", "veccore=ON"]
          - image: alma10
            is_special: true
            property: arm64
            overrides: ["CMAKE_BUILD_TYPE=RelWithDebInfo", "builtin_zlib=ON", "builtin_zstd=ON", "CMAKE_CXX_STANDARD=20"]
            architecture: ARM64
          - image: alma10
            is_special: true
            property: "clang Ninja"
            overrides: ["CMAKE_C_COMPILER=clang", "CMAKE_CXX_COMPILER=clang++", "CMAKE_CXX_STANDARD=20"]
            cmake_generator: Ninja
          # Fedora Rawhide with Python debug build
          - image: rawhide
            is_special: true
            property: "Fedora pydebug"
            overrides: ["CMAKE_CXX_STANDARD=23"]
          # Minimal build
          - image: alma10
            is_special: true
            minimal: true
            property: "minimal build"
            overrides: ["CMAKE_CXX_STANDARD=20"]
          # Disable GPU builds until the DNS problem is solved
          # - image: ubuntu2404-cuda
          #   is_special: true
          #   property: gpu
          #   extra-runs-on: gpu

    runs-on:
      - self-hosted
      - linux
      - ${{ matrix.architecture == null && 'x64' || matrix.architecture }}
      - ${{ matrix.extra-runs-on == null && 'cpu' || matrix.extra-runs-on }}

    name: |
      ${{ matrix.image }} ${{ matrix.property }}
      ${{ (github.event_name != 'schedule' && github.event_name != 'workflow_dispatch' && join( matrix.overrides, ', ' )) || '' }}

    container:
      image: registry.cern.ch/root-ci/${{ matrix.image }}:buildready # KEEP IN SYNC WITH env key below
      options: --security-opt label=disable --rm ${{ matrix.property == 'gpu' && '--device nvidia.com/gpu=all' || '' }} # KEEP IN SYNC WITH env key below
      volumes:
        - ${{ matrix.image }}_ccache_volume:/github/home/.cache/ccache
      env:
        CONTAINER_IMAGE: "registry.cern.ch/root-ci/${{ matrix.image }}:buildready" #KEEP IN SYNC WITH ABOVE
        CONTAINER_OPTIONS: "--security-opt label=disable --rm ${{ matrix.property == 'gpu' && '--device nvidia.com/gpu=all' || '' }}" #KEEP IN SYNC WITH ABOVE

    env:
      BUILD_DIR: /github/home/ROOT-CI/build
      INSTALL_DIR: /github/home/ROOT-CI/install
      POST_INSTALL_DIR: /github/home/ROOT-CI/PostInstall

    steps:
      - name: Configure large ccache
        if: ${{ matrix.is_special }}
        run: |
          ccache -o max_size=5G
          ccache -p || true
          ccache -s || true

      - name: Configure small ccache
        if: ${{ !matrix.is_special }}
        run: |
          ccache -o max_size=1.5G
          ccache -p || true
          ccache -s || true

      - name: Set up Python Virtual Env
        # if the `if` expr is false, `if` still has exit code 0.
        # if the `if` block is entered, the block's exit code becomes the exit
        # code of the `if`.
        run: 'if [ -d /py-venv/ROOT-CI/bin/ ]; then . /py-venv/ROOT-CI/bin/activate && echo PATH=$PATH >> $GITHUB_ENV; fi'

      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.ref_name }}

      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJSON(github) }}
          JOB_CONTEXT: ${{ toJSON(job) }}
          ENV_CONTEXT: ${{ toJSON(env) }}
        run: |
          echo "$GITHUB_CONTEXT"
          echo "--------------------------"
          echo "$JOB_CONTEXT"
          echo "--------------------------"
          echo "$ENV_CONTEXT"

      - name: Print debug info
        run:  'printf "%s@%s\\n" "$(whoami)" "$(hostname)";
               ls -la
              '
      - name: Apply option minimal request from matrix for this job
        if: ${{ matrix.minimal == true }}
        env:
          GLOBAL_CONFIG_DIR: '.github/workflows/root-ci-config/buildconfig'
          CONFIGFILE_STEM: '.github/workflows/root-ci-config/buildconfig/${{ matrix.image }}'
        run: |
          echo "Applying minimal request options"
          # Add commands to apply minimal request options here
          set -x
          cp "$GLOBAL_CONFIG_DIR/global-minimal.txt" "$GLOBAL_CONFIG_DIR/global.txt"
          if [ -f "${CONFIGFILE_STEM}-minimal.txt" ]; then
            cp "${CONFIGFILE_STEM}-minimal.txt" "${CONFIGFILE_STEM}.txt"
          fi

      - uses: root-project/gcc-problem-matcher-improved@main
        with:
          build-directory: /github/home/ROOT-CI/src/

      - name: Pull Request Build
        if:   ${{ github.event_name == 'pull_request' }}
        env:
          INCREMENTAL: ${{ !contains(github.event.pull_request.labels.*.name, 'clean build') }}
          GITHUB_PR_ORIGIN: ${{ github.event.pull_request.head.repo.clone_url }}
          CMAKE_GENERATOR: ${{ matrix.cmake_generator }}
          OVERRIDES: ${{ join( matrix.overrides, ' ') }}
        run: ".github/workflows/root-ci-config/build_root.py
                    --buildtype       RelWithDebInfo
                    --platform        ${{ matrix.image }}
                    --dockeropts      \"$CONTAINER_OPTIONS\"
                    --incremental     $INCREMENTAL
                    --base_ref        ${{ github.base_ref }}
                    --sha             ${{ github.sha }}
                    --pull_repository ${{ github.event.pull_request.head.repo.clone_url }}
                    --head_ref        refs/pull/${{ github.event.pull_request.number }}/head:${{ github.event.pull_request.head.ref }}
                    --head_sha        ${{ github.event.pull_request.head.sha }}
                    --repository      ${{ github.server_url }}/${{ github.repository }}
                    --overrides       ${GLOBAL_OVERRIDES} ${OVERRIDES}
              "

      - name: Workflow dispatch
        if:   ${{ github.event_name == 'workflow_dispatch' && !matrix.is_special }}
        run: ".github/workflows/root-ci-config/build_root.py
                    --buildtype      ${{ inputs.buildtype }}
                    --platform       ${{ matrix.image }}
                    --incremental    ${{ inputs.incremental }}
                    --base_ref       ${{ inputs.base_ref }}
                    --head_ref       ${{ inputs.head_ref }}
                    --binaries       ${{ inputs.binaries }}
                    --repository     ${{ github.server_url }}/${{ github.repository }}
              "

      - name: Nightly build
        if:   github.event_name == 'schedule'
        run: ".github/workflows/root-ci-config/build_root.py
                    --buildtype      Release
                    --platform       ${{ matrix.image }}
                    --incremental    false
                    --binaries       true
                    --base_ref       ${{ inputs.ref_name }}
                    --repository     ${{ github.server_url }}/${{ github.repository }}
              "

      - name: Update build cache after push to release branch
        if:   github.event_name == 'push'
        env:
          OVERRIDES: ${{ join( matrix.overrides, ' ') }}
        run: ".github/workflows/root-ci-config/build_root.py
                    --buildtype      RelWithDebInfo
                    --platform       ${{ matrix.image }}
                    --incremental    false
                    --base_ref       ${{ github.ref_name }}
                    --binaries       ${{ startsWith(github.ref, 'refs/tags/') }}
                    --repository     ${{ github.server_url }}/${{ github.repository }}
                    --overrides       ${GLOBAL_OVERRIDES} ${OVERRIDES}
              "

      - name: Upload test results
        if:   ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: Test Results ${{ matrix.image }} ${{ matrix.property }}
          path: /github/home/ROOT-CI/build/TestResults.xml

      - name: Upload binaries
        if:   ${{ !cancelled() && (inputs.binaries || github.event_name == 'schedule' || startsWith(github.ref, 'refs/tags/')) }}
        uses: actions/upload-artifact@v4
        with:
          name: Binaries ${{ matrix.image }} ${{ matrix.property }}
          path: /github/home/ROOT-CI/packages/root_v*
          if-no-files-found: error

      - name: ccache info (post)
        run: |
          ccache -s || true

      - name: Install
        run: "cmake --install ${{ env.BUILD_DIR }} --prefix ${{ env.INSTALL_DIR }}"

      - name: Build post-install test project
        run: |
          cmake -S test/PostInstall/ -B ${{ env.POST_INSTALL_DIR }} -DCMAKE_PREFIX_PATH=${{ env.INSTALL_DIR }};
          cmake --build ${{ env.POST_INSTALL_DIR }};

      - name: CTest in post-install test project
        working-directory: ${{ env.POST_INSTALL_DIR }}
        run: ctest --output-on-failure -j $(nproc)

  event_file:
    # For any event that is not a PR, the CI will always run. In PRs, the CI
    # can be skipped if the tag [skip-ci] or [skip ci] is written in the title.
    if: |
        (github.repository_owner == 'root-project' && github.event_name != 'pull_request') ||
        (github.event_name == 'pull_request' && !(contains(github.event.pull_request.title, '[skip-ci]') || contains(github.event.pull_request.title, '[skip ci]')))

    name: "Upload Event Payload"
    runs-on: ubuntu-latest
    steps:
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: Event File
        path: ${{ github.event_path }}
