name: 'Visual Studio - Latest'

on:
  workflow_dispatch:
    inputs:
      selected-job:
        description: 'Select which job to run'
        required: true
        default: 'Build'
        type: choice
        options:
        - Update
        - Reboot
        - Build
  schedule:
    - cron: '0  1 * * 3'
    - cron: '30 1 * * 3'
    - cron: '0  2 * * 3'

jobs:
  update-visualstudio-latest:
    if: ${{ github.event.schedule == '0  1 * * 3' || (github.event_name == 'workflow_dispatch' && inputs.selected-job == 'Update') }}

    name: Update Visual Studio - Latest

    runs-on:
      - self-hosted
      - windows
      - x64
      - latest

    steps:
    - name: Update Visual Studio
      shell: cmd
      run: "C:\\bin\\vs_update.bat"

  reboot-after-update:
    if: ${{ github.event.schedule == '30 1 * * 3' || (github.event_name == 'workflow_dispatch' && inputs.selected-job == 'Reboot') }}

    name: Reboot after update

    runs-on:
      - self-hosted
      - windows
      - x64
      - latest

    steps:
    - name: Reboot
      shell: cmd
      run: "shutdown /r"

  build-windows:
    if: ${{ github.event.schedule == '0  2 * * 3' || (github.event_name == 'workflow_dispatch' && inputs.selected-job == 'Build') }}

    permissions:
      contents: read

    strategy:
      fail-fast: false

    name: Build Visual Studio - Latest

    runs-on:
      - self-hosted
      - windows
      - x64
      - latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: master

      - name: Wednesday build
        if: (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
        shell: cmd
        run: "C:\\setenv.bat x64 &&
              python .github/workflows/root-ci-config/build_root.py
                    --buildtype        Release
                    --platform         windows10
                    --incremental      false
                    --binaries         false
                    --upload_artifacts false
                    --base_ref         master
                    --repository       ${{ github.server_url }}/${{ github.repository }}
                    --architecture     x64"

      - name: Upload test results
        if:   ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: Test Results - Visual Studio Latest
          path: C:/ROOT-CI/build/TestResults.xml

