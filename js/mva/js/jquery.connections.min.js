(function(t){t.fn.connections=function(o){if(o==="update"){return i(n,this)}else if(o==="remove"){return i(r,this)}else{o=t.extend(true,{borderClasses:{},class:"connection",css:{},from:this,tag:"connection",to:this,within:":root"},o);e(o);return this}};t.event.special.connections={teardown:function(e){i(r,t(this))}};var e=function(e){var r=e.borderClasses;var a=e.tag;var n=t(e.from);var i=t(e.to);var s=t(e.within);delete e.borderClasses;delete e.tag;delete e.from;delete e.to;delete e.within;s.each(function(){var t=this;var s=new Array;n.each(function(){var n=this;s.push(this);i.not(s).each(function(){o(t,[n,this],a,r,e)})})})};var o=function(e,o,r,a,i){var s=t.extend({position:"absolute"},i.css);var c=t("<"+r+"/>",i).css(s);c.appendTo(e);var d=(c.outerWidth()-c.innerWidth())/2;var h=(c.outerHeight()-c.innerHeight())/2;if(d<=0&&h<=0){d=h=1}var f={borderClasses:a,border_h:h,border_w:d,node_from:t(o[0]),node_to:t(o[1]),nodes_dom:o,css:s};if("none"===c.css("border-top-style")){f.css.borderStyle="solid"}t.data(c.get(0),"connection",f);t.data(c.get(0),"connections",[c.get(0)]);for(var v=0;v<2;v++){var m=c.add(t.data(o[v],"connections")).get();t.data(o[v],"connections",m);if(m.length==1){t(o[v]).on("connections.connections",false)}}n(c.get(0))};var r=function(e){var o=t.data(e,"connection").nodes_dom;for(var r=0;r<2;r++){var a=t(t.data(o[r],"connections")).not(e).get();t.data(o[r],"connections",a)}t(e).remove()};var a=function(t){t.rect_from=t.nodes_dom[0].getBoundingClientRect();t.rect_to=t.nodes_dom[1].getBoundingClientRect();var e=t.cache;t.cache=[t.rect_from.top,t.rect_from.right,t.rect_from.bottom,t.rect_from.left,t.rect_to.top,t.rect_to.right,t.rect_to.bottom,t.rect_to.left];t.hidden=0===(t.cache[0]|t.cache[1]|t.cache[2]|t.cache[3])||0===(t.cache[4]|t.cache[5]|t.cache[6]|t.cache[7]);t.unmodified=true;if(e===undefined){return t.unmodified=false}for(var o=0;o<8;o++){if(e[o]!==t.cache[o]){return t.unmodified=false}}};var n=function(e){var o=t.data(e,"connection");a(o);if(o.unmodified){return}var r=o.border_h;var n=o.border_w;var i=o.node_from;var s=o.node_to;var c=o.rect_from;var d=o.rect_to;var h=(c.bottom+c.top)/2;var f=(d.left+d.right)/2;var v=(d.bottom+d.top)/2;var m=(c.left+c.right)/2;var l=["right","left"];if(m>f){l=l.reverse();var u=Math.max(f-n/2,Math.min(c.right,d.right));f=m+n/2;m=u}else{m-=n/2;f=Math.min(f+n/2,Math.max(c.left,d.left))}var b=["bottom","top"];if(v>h){b=b.reverse();var u=Math.max(h-r/2,Math.min(c.bottom,d.bottom));h=v+r/2;v=u}else{h=Math.min(h,Math.max(c.top,d.top));v-=r/2}var g=f-m;var _=h-v;if(g<n){v=Math.max(v,Math.min(c.bottom,d.bottom));h=Math.min(h,Math.max(c.top,d.top));m=Math.max(c.left,d.left);f=Math.min(c.right,d.right);f=m=(m+f-n)/2}if(_<r){m=Math.max(m,Math.min(c.right,d.right));f=Math.min(f,Math.max(c.left,d.left));v=Math.max(c.top,d.top);h=Math.min(c.bottom,d.bottom);h=v=(v+h-r)/2}g=f-m;_=h-v;g<=0&&(r=0);_<=0&&(n=0);var p="border-"+b[0]+"-"+l[0]+"-radius: 0;"+"border-"+b[0]+"-"+l[1]+"-radius: 0;"+"border-"+b[1]+"-"+l[0]+"-radius: 0;";(r<=0||n<=0)&&(p+="border-"+b[1]+"-"+l[1]+"-radius: 0;");if(o.hidden){p+="display: none;"}else{o.css["border-"+b[0]+"-width"]=0;o.css["border-"+l[0]+"-width"]=0;o.css["border-"+b[1]+"-width"]=r;o.css["border-"+l[1]+"-width"]=n;var M=e.getBoundingClientRect();o.css.left=e.offsetLeft+m-M.left;o.css.top=e.offsetTop+v-M.top;o.css.width=g-n;o.css.height=_-r}var w=o.borderClasses;t(e).removeClass(w[b[0]]).removeClass(w[l[0]]).addClass(w[b[1]]).addClass(w[l[1]]).attr("style",p).css(o.css)};var i=function(e,o){return o.each(function(){var o=t.data(this,"connections");if(o instanceof Array){for(var r=0,a=o.length;r<a;r++){e(o[r])}}})}})(jQuery);