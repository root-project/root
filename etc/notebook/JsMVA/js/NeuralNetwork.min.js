(function(a){define(["d3"],function(b){return a({},b)})}(function(j,v){v.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};v.selection.prototype.moveToBack=function(){return this.each(function(){var y=this.parentNode.firstChild;if(y){this.parentNode.insertBefore(this,y)}})};var q={neuron:{colors:{input:"#00A000",hidden:"#0000C7",output:"#F6BD00",bias:"#8F686F"},mouseon:{change_radius:2,alpha:0.2}},synapse:{colors:{negative:"#00005E",positive:"#FF4B00"},deepNet_colors:{negative:"rgba(0,0,94, 0.4)",positive:"rgba(94,0,0, 0.4)"},default_width_range:[0.5,5],width_range:[0.5,5],deepNet_default_width_range:[0.5,2],deepNet_width_range:[0.5,2],default_alpha:0.7,alpha:0.7,mouseon:{width_range:[0.5,10],alpha:0.1}},variables:{labels_layer0_padding:0.03},legend:{pos:{x:150,y:10},rect:{width:10,height:10},dy:20,padding:10,deepNet_colors:{negative:"rgb(0,0,94)",positive:"rgb(94,0,0)"}}};var f;var t=function(z,y){return Number(Object.keys(z.layout["layer_"+y]).length-1)};var l=function(C,A,y){var z=t(C,y);var D=Array(z);for(var B=0;B<z;B++){D[B]={position:{x:(y+0.5)*f.width/(A),y:(B+0.5)*f.height/z},radius:f.height/(z+(z>5?0:5))/4,type:(B==(z-1)?"bias":(y==0?"input":"hidden")),neuron:B,layer:y};if(y==(A-1)){D[B]["type"]="output"}}return D};var m=function(A,z,y){var y=A.layout["layer_"+z]["neuron_"+y];if(y.nsynapses!=0){return y.weights}return[]};var x=function(E,A){var y=-1e+30;var D=1e+30;var C;for(var B=0;B<A;B++){for(var z=0;z<t(E,B);z++){C=v.max(m(E,B,z));if(y<C){y=C}C=v.min(m(E,B,z));if(D>C){D=C}}}return{min:D,max:y}};var e=function(E,z,y,F,D){var B=m(E,z,y);var C=Array(B.length);for(var A in B){C[A]={layer:z,neuron:y,nextlayer_neuron:A,pos:[F,D[A].position],weight:B[A],type:(B[A]<0?"negative":"positive")}}return C};var w=function(z,A){var C=z.variables;C.push("Bias node");var B=Array(C.length);for(var y in A){B[y]={x:A[y].position.x-q.variables["labels_layer0_padding"]*f.width,y:A[y].position.y,text:C[y]+":"}}return B};var c=function(y){y.append("text").text(function(z){return z[1].text}).attr("x",function(z){return z[1].x-this.getComputedTextLength()}).attr("y",function(z){return z[1].y+0.25*this.getBBox().height})};var k=function(z,E,y,C,A){if(A!==undefined){var B=v.zip(y,w(E,y))}else{var B=v.zip(y,Array(y.length))}var D=z.append("g").attr("id","layer_"+C).attr("class","layer").selectAll("g").data(B).enter().append("g").attr("id",function(F){return"neuron_"+C+""+F[0].neuron});D.append("circle").attr("r",function(F){return F[0].radius}).attr("cx",function(F){return F[0].position.x}).attr("cy",function(F){return F[0].position.y}).style("fill",function(F){return q.neuron["colors"][F[0].type]});if(A!==undefined){c(D)}g(z,D)};var n=v.scale.linear();var h=v.scale.linear();var p=v.svg.line().x(function(y){return y.x}).y(function(y){return y.y}).interpolate("linear");var d=function(A,E,D,z,C){for(var y in D){var B=e(E,z,y,D[y].position,C);A.select("g#neuron_"+z+""+y).selectAll("path").data(B).enter().append("path").moveToBack().attr("d",function(F){return p(F.pos)}).attr("stroke",function(F){return q.synapse["colors"][F.type]}).attr("stroke-width",function(F){return F.type=="positive"?n(F.weight):h(Math.abs(F.weight))}).attr("stroke-opacity",q.synapse["alpha"])}};var g=function(y,z){q.synapse.width_range=Object.assign({},q.synapse.default_width_range);q.synapse.alpha=Object.assign({},q.synapse.default_alpha);z.on("mouseover",function(C){n.range(q.synapse["mouseon"]["width_range"]);h.range(q.synapse["mouseon"]["width_range"]);var B=v.select(this).moveToFront().transition();B.selectAll("path").style("stroke-opacity",1).attr("stroke-width",function(D){return D.type=="positive"?n(D.weight):h(Math.abs(D.weight))});B.selectAll("circle").style("fill-opacity",1).attr("r",function(D){return D[0].radius*q.neuron["mouseon"]["change_radius"]});B.selectAll("text").attr("x",function(D){return D[1].x-D[0].radius-this.getComputedTextLength()});var A=y.selectAll("g.layer").selectAll("g").filter(function(D){return !(C[0].neuron==D[0].neuron&&C[0].layer==D[0].layer)}).transition();A.selectAll("circle").filter(function(D){return(C[0].layer+1)!=D[0].layer}).style("fill-opacity",q.neuron["mouseon"]["alpha"]).attr("r",function(D){return D[0].radius});A.selectAll("path").style("stroke-opacity",q.synapse["mouseon"]["alpha"])});z.on("mouseout",function(B){n.range(q.synapse["width_range"]);h.range(q.synapse["width_range"]);var A=y.selectAll("g.layer").selectAll("g").transition();A.selectAll("circle").style("fill-opacity",1).attr("r",function(C){return C[0].radius});A.selectAll("path").style("stroke-opacity",1).attr("stroke-width",function(C){return C.type=="positive"?n(C.weight):h(Math.abs(C.weight))});A.selectAll("text").attr("x",function(C){return C[1].x-this.getComputedTextLength()})})};var b=function(A){var B=[{c:q.synapse["colors"]["positive"],txt:"Positive weight"},{c:q.synapse["colors"]["negative"],txt:"Negative weight"}];var y=q.legend;var z=A.append("g").attr("id","legend");z.selectAll("g").data(B).enter().append("g").each(function(E,C){var D=v.select(this);D.append("rect").attr("x",f.width-y.pos.x).attr("y",y.pos.y+C*y.dy).attr("width",y.rect.width).attr("height",y.rect.height).style("fill",function(F){return F.c});D.append("text").attr("x",f.width-y.pos.x+y.rect.width+y.padding).attr("y",y.pos.y+C*y.dy+y.rect.height).text(function(F){return F.txt}).style("fill",function(F){return F.c})})};j.draw=function(E,z){if("layers" in z&&"synapses" in z){return j.drawDeepNetwork(E,z,true)}if("layers" in z&&"Biases" in z.layers[0]){return j.drawDeepNetwork(E,z)}var D,F;var y=v.select("#"+E);f={width:y.property("style")["width"],height:y.property("style")["height"]};F=z;q.synapse.width_range=Object.assign({},q.synapse.default_width_range);q.synapse.alpha=Object.assign({},q.synapse.default_alpha);n.range(q.synapse["width_range"]);h.range(q.synapse["width_range"]);D=y.append("svg").attr("id","svg_"+E).attr("width",f.width).attr("height",f.height);Object.keys(f).forEach(function(H){f[H]=Number(f[H].replace("px",""))});var A=Number(F.layout["nlayers"]);n.domain([0,x(F,A).max]);h.domain([0,Math.abs(x(F,A).min)]);var G=v.behavior.zoom().scaleExtent([1,20]).on("zoom",function(){D.attr("transform","translate("+v.event.translate+")scale("+v.event.scale+")")});D=D.on("dblclick",function(){G.scale(1);G.translate([0,0]);D.transition().attr("transform","translate(0,0)scale(1)")}).append("g").call(G).append("g");var C=Array(A);for(var B=0;B<A;B++){C[B]=l(F,A,B)}for(B=0;B<A;B++){k(D,F,C[B],B,B==0?true:undefined);d(D,F,C[B],B,C[B+1])}b(D)};var a=function(F){vars=F.variables;var E=F.layers;var C={layer_0:{nneurons:vars.length+1}};var y=Number(E[0]["Weights"]["row"]);for(var z=0;z<vars.length;z++){C.layer_0["neuron_"+z]={nsynapses:y,weights:E[0]["Weights"]["data"].slice(z*y,(z+1)*y)}}C.layer_0["neuron_"+vars.length]={nsynapses:Number(E[0]["Weights"]["row"]),weights:E[0]["Biases"]["data"]};vars.push("Bias node");for(var B=0;B<(E.length-1);B++){C["layer_"+(B+1)]={nneurons:Number(E[B]["Weights"]["row"])+1};var A=Number(E[B]["Weights"]["row"]);y=Number(E[B+1]["Weights"]["row"]);for(var z=0;z<A;z++){C["layer_"+(B+1)]["neuron_"+z]={nsynapses:y,weights:E[B+1]["Weights"]["data"].slice(z*y,(z+1)*y)}}C["layer_"+(B+1)]["neuron_"+A]={nsynapses:Number(E[B]["Weights"]["row"]),weights:E[B+1]["Biases"]["data"]}}C["layer_"+(B+1)]={nneurons:Number(E[B]["Weights"]["row"])};for(var z=0;z<Number(E[B]["Weights"]["row"]);z++){C["layer_"+(B+1)]["neuron_"+z]={nsynapses:0}}C.nlayers=B+2;var D={variables:vars,layout:C};return D};var s=function(F){vars=F.variables;vars.push("Bias node");var E=F.layers;var C=F.synapses["synapses"];var B={layer_0:{nneurons:vars.length}};var y;for(var z=0;z<vars.length;z++){y=Number(E[0]["Nodes"]);B.layer_0["neuron_"+z]={nsynapses:y,weights:C.slice(z*y,(z+1)*y)}}for(var A=0;A<(E.length-1);A++){B["layer_"+(A+1)]={nneurons:Number(E[A]["Nodes"])};y=Number(E[A+1]["Nodes"]);for(var z=0;z<=Number(E[A]["Nodes"]);z++){B["layer_"+(A+1)]["neuron_"+z]={nsynapses:y,weights:C.slice(z*y,(z+1)*y)}}}B["layer_"+(A+1)]={nneurons:Number(E[A]["Nodes"])};for(var z=0;z<Number(E[A]["Nodes"]);z++){B["layer_"+(A+1)]["neuron_"+z]={nsynapses:0}}B.nlayers=A+2;var D={variables:vars,layout:B};return D};var i=function(B,y,C){for(var A=0;A<y.length;A++){B.beginPath();B.arc(y[A].position.x+30,y[A].position.y,y[A].radius,0,2*Math.PI);B.fillStyle=q.neuron["colors"][y[A].type];B.fill();B.closePath()}if(C!==undefined){B.font="16px bold Comic Sans MS";B.fillStyle="#000";var D;for(var z=0;z<C.length;z++){D=C[z]+":";B.fillText(D,y[z].position.x+10-B.measureText(D).width,y[z].position.y+5)}}};var r=function(G,D,z,B,y){var E,A,C;for(E in z){var F=e(D,B,E,z[E].position,y);for(A in F){C=F[A];G.beginPath();G.moveTo(C.pos[0].x+30,C.pos[0].y);G.lineTo(C.pos[1].x+30,C.pos[1].y);G.lineWidth=C.type=="positive"?n(C.weight):h(Math.abs(C.weight));G.strokeStyle=q.synapse["deepNet_colors"][C.type];G.stroke();G.closePath()}}};var u=function(A,C){var y=Number(C.layout["nlayers"]);var B=Array(y);for(var z=0;z<y;z++){B[z]=l(C,y,z)}for(z=0;z<y;z++){r(A,C,B[z],z,B[z+1]);i(A,B[z],z==0?C.variables:undefined)}};var o=function(y){y.beginPath();y.fillStyle=q.legend["deepNet_colors"]["positive"];y.rect(f.width-170,10,q.legend["rect"]["width"],q.legend["rect"]["height"]);y.fill();y.closePath();y.beginPath();y.fillStyle=q.legend["deepNet_colors"]["negative"];y.rect(f.width-170,30,q.legend["rect"]["width"],q.legend["rect"]["height"]);y.fill();y.closePath();y.font="16px bold Comic Sans MS";y.fillStyle=q.legend["deepNet_colors"]["positive"];y.fillText("Positive weight",f.width-150,20);y.fillStyle=q.legend["deepNet_colors"]["negative"];y.fillText("Negative weight",f.width-150,40)};j.drawDeepNetwork=function(C,z,A){if(A===undefined){A=false}var B=v.select("#"+C);f={width:Number(B.property("style")["width"].replace("px","")),height:Number(B.property("style")["height"].replace("px",""))};if(A){net=s(z)}else{net=a(z)}n.range(q.synapse["deepNet_width_range"]);h.range(q.synapse["deepNet_width_range"]);var y=B.append("canvas").attr("width",f.width+"px").attr("height",f.height+"px").call(v.behavior.zoom().scaleExtent([1,20]).on("zoom",function(){y.save();y.clearRect(0,0,f.width,f.height);y.translate(v.event.translate[0],v.event.translate[1]);y.scale(v.event.scale,v.event.scale);u(y,net);o(y);y.restore()})).node().getContext("2d");u(y,net);o(y)};Object.seal(j);return j}));